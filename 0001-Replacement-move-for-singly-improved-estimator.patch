From 60846f43eabe33c04469a785a759787642fe93fd Mon Sep 17 00:00:00 2001
From: Alexander Kowalski <akowalski@physik.uni-wuerzburg.de>
Date: Wed, 11 Oct 2023 11:06:41 +0200
Subject: [PATCH 1/3] Replacement move for singly improved estimator

---
 src/ctqmc_fortran/CTQMC.F90 | 23 ++++++++++++++++++++---
 1 file changed, 20 insertions(+), 3 deletions(-)

diff --git a/src/ctqmc_fortran/CTQMC.F90 b/src/ctqmc_fortran/CTQMC.F90
index 7f358609..e98893a9 100644
--- a/src/ctqmc_fortran/CTQMC.F90
+++ b/src/ctqmc_fortran/CTQMC.F90
@@ -6131,8 +6131,10 @@ subroutine StepWormReplace(Sector)
    !select one of the two worm operators for exchange
    if(Sector .eq. SectorG .or. Sector .eq. SectorG4) then
       rand=randint(1, size(DTrace%wormContainer))
-   elseif(Sector .eq. SectorGSigma &
-     .or. Sector .eq. SectorH4 &
+   else if (Sector .eq. SectorGSigma) then
+      rand = randint(1, 4)
+      if (rand /= 4) nobj = 3  ! part of Q selected
+   elseif(Sector .eq. SectorH4 &
      .or. Sector .eq. SectorQUDdag) then ! I hope this works for QUDdag
       !we only exchange the operators which are not equal time operators
       rand=randint(4, size(DTrace%wormContainer(4:)) + 3)
@@ -6243,7 +6245,7 @@ subroutine StepWormReplace(Sector)
    wca=DTrace%wormContainer(rand)%p%CA
 
    ! TODO: someone should look into this more carefully
-   if(b_offdiag .and. .not. (Sector == SectorQQ .or. Sector == SectorQ4 .or. Sector == SectorUccaa .or. Sector == SectorUcaca .or. Sector == SectorNQQdag)) then
+   if(b_offdiag .and. .not. (Sector == SectorGSigma .or. Sector == SectorQQ .or. Sector == SectorQ4 .or. Sector == SectorUccaa .or. Sector == SectorUcaca .or. Sector == SectorNQQdag)) then
       N=(DTrace%NOper-size(DTrace%wormContainer))/2
    else
       N=DTrace%NOSOper(wb,ws)/2
@@ -6392,6 +6394,21 @@ subroutine StepWormReplace(Sector)
          qrepind = (/3, 4, huge(qrepind(1))/)
          qtimeind = (/1, 2, huge(qtimeind(1))/)
       end select
+   else if (Sector == SectorGSigma .and. rand /= 4) then
+      ! same as for QQ, but only the first three indices are Q (and 4
+      ! is of a single operator handled like part of G)
+      multimove = .true.
+      select case (rand)
+      case (1)
+         qrepind = (/3, 2, 1/)
+         qtimeind = (/2, 3, 1/)
+      case (2)
+         qrepind = (/1, 3, 2/)
+         qtimeind = (/1, 2, 3/)
+      case (3)
+         qrepind = (/1, 2, 3/)
+         qtimeind = (/1, 3, 2/)
+      end select
    else
       multimove = .false. ! just to be very explicit
    end if
-- 
2.42.0

