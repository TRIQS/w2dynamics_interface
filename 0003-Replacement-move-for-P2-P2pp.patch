From d9abfa9e4657429fa1f5af459469546820c10048 Mon Sep 17 00:00:00 2001
From: Alexander Kowalski <akowalski@physik.uni-wuerzburg.de>
Date: Tue, 31 Oct 2023 14:41:48 +0100
Subject: [PATCH 3/3] Replacement move for P2, P2pp

---
 src/ctqmc_fortran/CTQMC.F90 | 40 ++++++++++++++++++++++++++++++++++++-
 1 file changed, 39 insertions(+), 1 deletion(-)

diff --git a/src/ctqmc_fortran/CTQMC.F90 b/src/ctqmc_fortran/CTQMC.F90
index 4eb4533d..5940e8ca 100644
--- a/src/ctqmc_fortran/CTQMC.F90
+++ b/src/ctqmc_fortran/CTQMC.F90
@@ -6138,13 +6138,15 @@ subroutine StepWormReplace(Sector)
      .or. Sector .eq. SectorQUDdag) then ! I hope this works for QUDdag
       !we only exchange the operators which are not equal time operators
       rand=randint(4, size(DTrace%wormContainer(4:)) + 3)
+   else if (Sector == SectorP2 .or. Sector == SectorP2pp) then
+      rand = randint(1, 4)
+      nobj = 2
    elseif(Sector .eq. SectorP3) then
       rand = randint(1, 4)
       if (rand > 2) nobj = 2
    elseif(Sector .eq. SectorP3pp) then
       rand = randint(1, 4)
       if(modulo(rand, 2) == 0) nobj = 2
-   !we do not attempt replacment moves for two legged GF
    elseif (Sector == SectorQQ) then
       ! move parts of three-operator object
       nobj = 3
@@ -6359,6 +6361,42 @@ subroutine StepWormReplace(Sector)
          qrepind = (/5, 4, 6/)
          qtimeind = (/1, 3, 2/)
       end select
+   else if (Sector == SectorP2) then
+      ! same as above, but only the first one is moved and the third place is unused
+      multimove = .true.
+      select case (rand)
+      ! huge to provoke segmentation fault as much as possible in case of programmer error
+      case (1)
+         qrepind = (/2, 1, huge(qrepind(1))/)
+         qtimeind = (/1, 2, huge(qtimeind(1))/)
+      case (2)
+         qrepind = (/1, 2, huge(qrepind(1))/)
+         qtimeind = (/2, 1, huge(qtimeind(1))/)
+      case (3)
+         qrepind = (/4, 3, huge(qrepind(1))/)
+         qtimeind = (/1, 2, huge(qtimeind(1))/)
+      case (4)
+         qrepind = (/3, 4, huge(qrepind(1))/)
+         qtimeind = (/2, 1, huge(qtimeind(1))/)
+      end select
+   else if (Sector == SectorP2pp) then
+      ! same as above, but only the first one is moved and the third place is unused
+      multimove = .true.
+      select case (rand)
+      ! huge to provoke segmentation fault as much as possible in case of programmer error
+      case (1)
+         qrepind = (/3, 1, huge(qrepind(1))/)
+         qtimeind = (/1, 2, huge(qtimeind(1))/)
+      case (2)
+         qrepind = (/4, 2, huge(qrepind(1))/)
+         qtimeind = (/1, 2, huge(qtimeind(1))/)
+      case (3)
+         qrepind = (/1, 3, huge(qrepind(1))/)
+         qtimeind = (/2, 1, huge(qtimeind(1))/)
+      case (4)
+         qrepind = (/2, 4, huge(qrepind(1))/)
+         qtimeind = (/2, 1, huge(qtimeind(1))/)
+      end select
    else if (Sector == SectorP3 .and. nobj > 1) then
       ! same as above, but only the first one is moved and the third place is unused
       multimove = .true.
-- 
2.42.0

